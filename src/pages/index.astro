---
import { db, Result, sql } from 'astro:db';
import LeaderboardSpeedlifyScore from '../components/LeaderboardSpeedlifyScore.astro';
import LeaderboardURL from '../components/LeaderboardURL.astro';
import Layout from '../layouts/Layout.astro';
import { TestResult } from '../util/data-schema';

const SiteBucket = sql`(PARTITION BY ${Result.siteHash} ORDER BY ${Result.siteHash})`;
const ExtendedResult = db.$with('ExtendedResult').as(
	db
		.select({
			siteHash: Result.siteHash,
			runTime: Result.runTime,
			data: Result.data,
			latestRun: sql`unixepoch (MAX(${Result.runTime}) OVER ${SiteBucket})`
				.mapWith(Number)
				.as('latestRun'),
			isNew: sql`CASE WHEN COUNT(*) OVER ${SiteBucket} IS 1 THEN 1 ELSE 0 END`
				.mapWith(Boolean)
				.as('isNew'),
		})
		.from(Result)
);

const sites = (
	await db
		.with(ExtendedResult)
		.select()
		.from(ExtendedResult)
		.where(
			sql`unixepoch (${ExtendedResult.runTime}) >= (${ExtendedResult.latestRun} - 24 * 60 * 60)`
		)
		.orderBy(sql`${ExtendedResult.data}->>'$.ranks.cumulative'`)
).map((site) => ({ ...site, data: TestResult.parse(site.data) }));
---

<Layout>
	<div class="leaderboard-wrapper">
		<section class="leaderboard">
			{
			  sites.map(({ isNew, siteHash, data }, index) => {
				const id = 'site-' + siteHash;
				const detailsHref = `/site/${siteHash}`;
				return (
				  <li id={id} class="leaderboard-list-entry">
					<div class="leaderboard-rank">
					  <a href={`#${id}`}>{index + 1}</a>
					</div>
					<div class="leaderboard-trophies">
					  {data.lighthouse.total === 400 && 'üèÜ'}
					  {['ü•á', 'ü•à', 'ü•â'][index]}
					  {isNew && <span title="New entry">‚ú®</span>}
					</div>
					<LeaderboardURL data={data} href={detailsHref} />
					<div class="leaderboard-host">
					  {/* Add host information here */}
					</div>
					<LeaderboardSpeedlifyScore data={data} siteHash={siteHash} />
					<div class="leaderboard-data-right">
					  <a href={detailsHref} data-expand-alias data-js-only>
						<span>History</span>
					  </a>
					</div>
				  </li>
				);
			  })
			}
		  </section>


	</div>
	<script>
		import 'speedlify-score';
	</script>
	<style>
	.leaderboard {
      list-style-type: none;
      padding: 0;
    }
	.leaderboard-wrapper {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, 'Open Sans', 'Helvetica Neue', sans-serif;
      max-width: 1200px;
      margin: 0 auto;
      background-color: var(--background);
      border-radius: 8px;
      box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1);
    }
    .leaderboard {
      list-style-type: none;
      padding: 0;
      margin: 0;
    }
    .leaderboard-entry {
      display: grid;
      grid-template-columns: 100px 1fr 150px 100px 20px;
      align-items: center;
      padding: 12px 16px;
      border-bottom: 1px solid #e5e7eb;
    }
    .leaderboard-entry:hover {
      background-color: #f9fafb;
    }
    .leaderboard-date {
      font-family: monospace;
      color: #6b7280;
    }
    .leaderboard-name {
      font-weight: 500;
      color: #111827;
    }
    .leaderboard-updates {
      text-align: right;
    }
    .leaderboard-updates .addition {
      color: #059669;
      margin-right: 8px;
    }
    .leaderboard-updates .change {
      color: #2563eb;
    }
    .leaderboard-category {
      text-align: right;
    }
    .leaderboard-category::before {
      content: attr(data-category);
      background-color: #f3f4f6;
      color: #374151;
      padding: 2px 6px;
      border-radius: 4px;
      font-size: 0.75rem;
      font-weight: 500;
    }
    .leaderboard-arrow {
      color: #9ca3af;
    }
    .leaderboard-list-entry {
      display: flex;
      align-items: center;
      padding: 1em 0;
      border-bottom: 1px solid #fff3;
    }
    .leaderboard-rank,
    .leaderboard-trophies,
    .leaderboard-host,
    .leaderboard-data-right {
      padding: 0 1em;
    }
    .leaderboard-trophies {
      white-space: nowrap;
    }
	a[href^='/site/'] {
		white-space: nowrap;
		display: inline-block;
		text-decoration: none;
		background-color: #fff1;
		border-radius: 50px;
		border: 1px solid #fff3;
		padding: 0.5em 1em;
		text-align: center;
		line-height: normal;
	}
	.leaderboard-trophies {
		white-space: nowrap;
	}
	</style>
</Layout>
